%1541572138110
@
sname=DefineDataObjectTutorials
slabel=定义数据对象
stype=swtGuide
sgroup=数据和信息.数据对象.-1000|教程
sicon=icons/application.png
sth_sortWeight=40
sstyledTextForInsert=parentContext.parentContext.codeText
suseTargetThingDoc=false
ssimpleBrowser=false
sdescriptors=xworker.swt.xworker.ThingRegistThing
sinheritDescription=false
sth_createIndex=true
sth_registThing=command|xworker.command.Root
sth_registMyChilds=false
sth_registDisabled=false
sth_mark=false
  @/@SwtGuide
  sname=SwtGuide
  sshowHeader=true
  sdescriptors=xworker.swt.xworker.ThingRegistThing/@SwtGuide
  sinheritDescription=false
  sth_createIndex=false
  sth_registMyChilds=false
  sth_registDisabled=false
  sth_mark=false
  sid=SwtGuide
    @/@SwtGuide/@SimpleBrowser
    sname=SimpleBrowser
    slabel=定义数据对象
    stype=thingDoc
    Sdescription=
#$@text#$@
<p>定义数据对象通常是针对特定类型的数据的，如数据库、Excel、CSV等等，定义了数据对象后可以快速的映射该类型的数据对象，通过数据对象就可以操作数据了。</p>

<p><strong>定义数据对象的方法</strong></p>

<ol>
	<li><strong>继承DataObject</strong><br />
	创建一个事物模型，让它继承xworker.dataObject.DataObject模型。<br />
	&nbsp;</li>
	<li><strong>定义属性</strong><br />
	添加Attribute（属性）子节点，让它继承xworker.dataObject.Attribute模型。<br />
	&nbsp;</li>
	<li><strong>实现数据对象的接口</strong><br />
	根据需要可以实现doLoad、doCreate、doUpdate、doDelete和doQuery等等方法&nbsp;。<br />
	&nbsp;</li>
	<li><strong>注册数据对象</strong><br />
	把新的数据对象以child的方式注册到xworker.dataObject.DataObjects模型下，这样大家都可以看到它了。&nbsp;&nbsp;&nbsp;</li>
</ol>

<p>本教程以ListDataObject为示例来演示如何定义一个数据对象。ListDataObject是对java.uti.List&lt;Object&gt;映射的数据对象。</p>

<p>点击<strong>下一步按钮</strong>继续本教程。</p>

<p>&nbsp;</p>
#$@text#$@
    sdescriptors=xworker.swt.guide.Guide/@SimpleBrowser
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=SimpleBrowser
      @/@SwtGuide/@SimpleBrowser/@Buttons
      sname=Buttons
      sdescriptors=xworker.swt.guide.Node/@Buttons
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Buttons
        @/@SwtGuide/@SimpleBrowser/@Buttons/@nextButton
        sname=nextButton
        slabel=下一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton
    @/@SwtGuide/@BrowserComposite
    sname=BrowserComposite
    slabel=ListDataObject
    sbrowserLocation=top
    surlType=thingDoc
    sweights=20,80
    Sdescription=
#$@text#$@
<p>下面的事物模型是ListDataObject，通过它来演示如何定义数据对象。</p>

<p>点击<strong>下一步按钮</strong>查看接口方法的实现。</p>
#$@text#$@
    sdescriptors=xworker.swt.guide.Guide/@BrowserComposite
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=BrowserComposite
      @/@SwtGuide/@BrowserComposite/@Composite
      sname=Composite
      sBORDER=false
      sH_SCROLL=false
      sV_SCROLL=false
      sNO_BACKGROUND=false
      sNO_FOCUS=false
      sNO_MERGE_PAINTS=false
      sNO_REDRAW_RESIZE=false
      sNO_RADIO_GROUP=false
      sEMBEDDED=false
      sDOUBLE_BUFFERED=false
      scapture=false
      senabled=true
      sredraw=true
      svisible=true
      sdescriptors=xworker.swt.guide.Guide/@BrowserComposite/@Composite
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Composite
        @/@SwtGuide/@BrowserComposite/@Composite/@compositeFillLayout
        sname=compositeFillLayout
        stype=SWT.HORIZONTAL
        sdescriptors=xworker.swt.Layouts/@FillLayout
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=compositeFillLayout
        @/@SwtGuide/@BrowserComposite/@Composite/@ThingEditor
        sname=ThingEditor
        sthingPath=xworker.dataObject.java.ListDataObject
        stitle=true
        suseRootThing=false
        ssaveActionContainer=false
        sdescriptors=xworker.swt.Widgets/@ThingEditor
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=ThingEditor
      @/@SwtGuide/@BrowserComposite/@Buttons
      sname=Buttons
      sdescriptors=xworker.swt.guide.Node/@Buttons
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Buttons
        @/@SwtGuide/@BrowserComposite/@Buttons/@nextButton
        sname=nextButton
        slabel=上一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton1
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton
        @/@SwtGuide/@BrowserComposite/@Buttons/@nextButton1
        sname=nextButton
        slabel=下一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton1
    @/@SwtGuide/@BrowserComposite1
    sname=BrowserComposite
    slabel=doLoad
    sbrowserLocation=top
    surlType=thingDoc
    sweights=40,60
    Sdescription=
#$@text#$@
<p>doLoad方法用于通过主键加载一个数据对象，如加载数据库通过主键的获取的一条记录，如果有错误抛出异常，没有对应记录返回null，正常则返回该数据对象。</p>

<p>下面是ListDataObject的doLoad方法的实现，主要变量和方法如下：</p>

<ul>
	<li><strong>self: Thing</strong><br />
	数据对象定义模型。<br />
	&nbsp;</li>
	<li><strong>theData: DataObject</strong><br />
	要加载的数据对象。<br />
	&nbsp;</li>
	<li><strong>Object[][] keyDatas = theData.getKeyAndDatas()</strong><br />
	获取主键的定义和主键的值。</li>
</ul>

<p>&nbsp;</p>
#$@text#$@
    sdescriptors=xworker.swt.guide.Guide/@BrowserComposite
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=BrowserComposite1
      @/@SwtGuide/@BrowserComposite1/@Composite
      sname=Composite
      sBORDER=false
      sH_SCROLL=false
      sV_SCROLL=false
      sNO_BACKGROUND=false
      sNO_FOCUS=false
      sNO_MERGE_PAINTS=false
      sNO_REDRAW_RESIZE=false
      sNO_RADIO_GROUP=false
      sEMBEDDED=false
      sDOUBLE_BUFFERED=false
      scapture=false
      senabled=true
      sredraw=true
      svisible=true
      sdescriptors=xworker.swt.guide.Guide/@BrowserComposite/@Composite
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Composite
        @/@SwtGuide/@BrowserComposite1/@Composite/@compositeFillLayout
        sname=compositeFillLayout
        stype=SWT.HORIZONTAL
        sdescriptors=xworker.swt.Layouts/@FillLayout
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=compositeFillLayout
        @/@SwtGuide/@BrowserComposite1/@Composite/@codeText
        sname=codeText
        sstyle=MULTI
        sFULL_SELECTION=false
        sREAD_ONLY=true
        sWRAP=false
        sH_SCROLL=true
        sV_SCROLL=true
        sBORDER=false
        salign=LEFT
        slineNumber=false
        Stext=
#$@text#$@
@SuppressWarnings("unchecked")
    public static Object doLoad(ActionContext actionContext) throws OgnlException{
    	   //数据对象定义
        Thing self = actionContext.getObject("self");
        //数据对象，theData为约定的名字
        DataObject theData = actionContext.getObject("theData");
        
        //数据对象的描述者，应该就是self变量
        Thing descriptor = theData.getMetadata().getDescriptor();
        //主键的定义和主键的值
        Object[][] keyDatas = theData.getKeyAndDatas();
        if(keyDatas == null || keyDatas.length == 0){
            logger.warn("no keys data cannot load, listDataObjectPath=" + descriptor.getMetadata().getPath());
            throw new ActionException("No keys, data cannot laod");
        }
        
        //获取要管理的List数据
        List<Object> datas = (List<Object>) self.doAction("getListData", actionContext);        
        if(datas == null){
            logger.warn("no thing datas setted, listDataObjectPath=" + descriptor.getMetadata().getPath());
            throw new ActionException("No thing datas setted");
        }
        
        //通过主键查找匹配的对象
        Object data = null;
        Object keyExp = Ognl.parseExpression(((Thing) keyDatas[0][0]).getString("propertyPath"));
        for(Object child : datas){
            boolean have = true;
            for(int i=0; i<keyDatas.length; i++){
                if(!keyDatas[i][1].equals(Ognl.getValue(keyExp, child))){
                   have = false;
                   break;
                }        
            }
            if(have){
                 data = child;
                 break;
            }
        }
        
        if(data != null){
        	//根据attribute（属性的定义）来设置DataObject的值，向DataObject填充属性值
            for(Thing attribute : self.getChilds("attribute")){
                String propertyPath = attribute.getStringBlankAsNull("propertyPath");
                String name = attribute.getString("name");
                if(propertyPath ==null){
                    theData.put(name, data);
                }else{
                    theData.put(name, OgnlUtil.getValue(attribute, "propertyPath", data));
                }
            }
            
            return theData;
        }else{
            //log.info("数据对象不存在");
            return null;
        }
    }
#$@text#$@
        sNO_BACKGROUND=false
        sNO_FOCUS=false
        sNO_MERGE_PAINTS=false
        sNO_REDRAW_RESIZE=false
        sNO_RADIO_GROUP=false
        sEMBEDDED=false
        sDOUBLE_BUFFERED=false
        scapture=false
        senabled=true
        sredraw=true
        svisible=true
        sdescriptors=xworker.swt.Widgets/@StyledText
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=codeText
          @/@SwtGuide/@BrowserComposite1/@Composite/@codeText/@Colorer
          sname=Colorer
          scodeName=java
          scodeType=java
          sdescriptors=xworker.swt.custom.StyledText/@Colorer
          sinheritDescription=false
          sth_createIndex=false
          sth_registMyChilds=false
          sth_registDisabled=false
          sth_mark=false
          sid=Colorer
      @/@SwtGuide/@BrowserComposite1/@Buttons
      sname=Buttons
      sdescriptors=xworker.swt.guide.Node/@Buttons
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Buttons
        @/@SwtGuide/@BrowserComposite1/@Buttons/@nextButton
        sname=nextButton
        slabel=上一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton1
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton
        @/@SwtGuide/@BrowserComposite1/@Buttons/@nextButton1
        sname=nextButton
        slabel=下一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton1
    @/@SwtGuide/@BrowserComposite11
    sname=BrowserComposite
    slabel=doCreate
    sbrowserLocation=top
    surlType=thingDoc
    Sdescription=
#$@text#$@
<p>doCreate方法用于通过数据对象来创建一条数据，如在数据库中插入一条记录。doCreate方法执行成功返回该数据对象，否则抛出相应的异常。</p>

<p>下面是ListDataObject的doCreate方法的实现。</p>

<p>&nbsp;</p>
#$@text#$@
    sdescriptors=xworker.swt.guide.Guide/@BrowserComposite
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=BrowserComposite11
      @/@SwtGuide/@BrowserComposite11/@Composite
      sname=Composite
      sBORDER=false
      sH_SCROLL=false
      sV_SCROLL=false
      sNO_BACKGROUND=false
      sNO_FOCUS=false
      sNO_MERGE_PAINTS=false
      sNO_REDRAW_RESIZE=false
      sNO_RADIO_GROUP=false
      sEMBEDDED=false
      sDOUBLE_BUFFERED=false
      scapture=false
      senabled=true
      sredraw=true
      svisible=true
      sdescriptors=xworker.swt.guide.Guide/@BrowserComposite/@Composite
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Composite
        @/@SwtGuide/@BrowserComposite11/@Composite/@compositeFillLayout
        sname=compositeFillLayout
        stype=SWT.HORIZONTAL
        sdescriptors=xworker.swt.Layouts/@FillLayout
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=compositeFillLayout
        @/@SwtGuide/@BrowserComposite11/@Composite/@codeText
        sname=codeText
        sstyle=MULTI
        sFULL_SELECTION=false
        sREAD_ONLY=true
        sWRAP=false
        sH_SCROLL=true
        sV_SCROLL=true
        sBORDER=false
        salign=LEFT
        slineNumber=false
        Stext=
#$@text#$@
@SuppressWarnings("unchecked")
	public static Object doCreate(ActionContext actionContext) throws OgnlException{
    	//数据对象定义
        Thing self = actionContext.getObject("self");
        //数据对象
        DataObject theData = actionContext.getObject("theData");
        
        //是否需要自动初始化
        if(self.getBoolean("autoInit")){
            theData.doAction(self.getString("autoInitAction"), actionContext);
        }
        
        //查找同主键的对象是否已经存在
        List<Object> dataObjects = (List<Object>) self.doAction("getListData", actionContext);
        if(dataObjects == null){
            logger.warn("ListDataObject: list data not exists, name=" + self.get("listData"));
            return null;
        }
        
        Object[][] keyDatas = theData.getKeyAndDatas();
        if(self.getBoolean("autoGenerateId")){
            Object id = self.doAction("generateId", actionContext);
            theData.put(((Thing) keyDatas[0][0]).getString("name"), id);
            keyDatas[0][1] = id;
        }
        boolean have = false;
        for(Object child : dataObjects){
            boolean ok = true;
            for(Object[] keyData : keyDatas){
                if(keyData[1] != null && keyData[1] != Ognl.getValue(((Thing) keyData[0]).getString("propertyPath"), child)){
                    ok = false;
                    break;
                }
            }
            
            if(ok){        
                have = true;
                break;
            }
        }
        
        if(!have){     
        	//对象不存在，创建新的对象，并从
            Object child = self.doAction("createInstance", actionContext);
            for(Thing attribute : self.getChilds("attribute")){
                Ognl.setValue(attribute.getString("propertyPath"), child, Ognl.getValue(attribute.getString("name"), theData));
            }            
        }else{
            throw new ActionException("数据重复，不能创建新数据");
        }
        
        return theData;
    }
#$@text#$@
        sNO_BACKGROUND=false
        sNO_FOCUS=false
        sNO_MERGE_PAINTS=false
        sNO_REDRAW_RESIZE=false
        sNO_RADIO_GROUP=false
        sEMBEDDED=false
        sDOUBLE_BUFFERED=false
        scapture=false
        senabled=true
        sredraw=true
        svisible=true
        sdescriptors=xworker.swt.Widgets/@StyledText
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=codeText
          @/@SwtGuide/@BrowserComposite11/@Composite/@codeText/@Colorer
          sname=Colorer
          scodeName=java
          scodeType=java
          sdescriptors=xworker.swt.custom.StyledText/@Colorer
          sinheritDescription=false
          sth_createIndex=false
          sth_registMyChilds=false
          sth_registDisabled=false
          sth_mark=false
          sid=Colorer
      @/@SwtGuide/@BrowserComposite11/@Buttons
      sname=Buttons
      sdescriptors=xworker.swt.guide.Node/@Buttons
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Buttons
        @/@SwtGuide/@BrowserComposite11/@Buttons/@nextButton
        sname=nextButton
        slabel=上一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton1
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton
        @/@SwtGuide/@BrowserComposite11/@Buttons/@nextButton1
        sname=nextButton
        slabel=下一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton1
    @/@SwtGuide/@BrowserComposite111
    sname=BrowserComposite
    slabel=doUpdate
    sbrowserLocation=top
    surlType=thingDoc
    Sdescription=
#$@text#$@
<p>doUpdate方法用于通过数据对象来更新数据，如更新数据库中的一条记录。doUpdate成功更新了记录返回true，没有更新记录返回false。</p>

<p>下面是ListDataObject的doUpdate方法的实现。</p>

<p>&nbsp;</p>
#$@text#$@
    sdescriptors=xworker.swt.guide.Guide/@BrowserComposite
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=BrowserComposite111
      @/@SwtGuide/@BrowserComposite111/@Composite
      sname=Composite
      sBORDER=false
      sH_SCROLL=false
      sV_SCROLL=false
      sNO_BACKGROUND=false
      sNO_FOCUS=false
      sNO_MERGE_PAINTS=false
      sNO_REDRAW_RESIZE=false
      sNO_RADIO_GROUP=false
      sEMBEDDED=false
      sDOUBLE_BUFFERED=false
      scapture=false
      senabled=true
      sredraw=true
      svisible=true
      sdescriptors=xworker.swt.guide.Guide/@BrowserComposite/@Composite
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Composite
        @/@SwtGuide/@BrowserComposite111/@Composite/@compositeFillLayout
        sname=compositeFillLayout
        stype=SWT.HORIZONTAL
        sdescriptors=xworker.swt.Layouts/@FillLayout
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=compositeFillLayout
        @/@SwtGuide/@BrowserComposite111/@Composite/@codeText
        sname=codeText
        sstyle=MULTI
        sFULL_SELECTION=false
        sREAD_ONLY=true
        sWRAP=false
        sH_SCROLL=true
        sV_SCROLL=true
        sBORDER=false
        salign=LEFT
        slineNumber=false
        Stext=
#$@text#$@
@SuppressWarnings("unchecked")
	public static Object doUpdate(ActionContext actionContext) throws OgnlException{
    	//数据对象定义
        Thing self = actionContext.getObject("self");
        //数据对象
        DataObject theData = actionContext.getObject("theData");
        
        //根据主键查找对应的对象
        List<Object> datas = (List<Object>) self.doAction("getListData", actionContext);
        Object[][] keyDatas = theData.getKeyAndDatas();
        boolean updated = false;
        for(Object child : datas){
            boolean ok = true;
            for(Object[] keyData : keyDatas){
                if(keyData[1] != Ognl.getValue(((Thing) keyData[0]).getString("propertyPath"), child)){
                    ok = false;
                    break;
                }
            }
        
            if(ok){
            	//如果存在则更新对应的对象
                for(Thing attribute : self.getChilds("attribute")){
                    //log.info(attribute.name + "=" + Ognl.getValue(attribute.name, theData));
                    //log.info(attribute.name + "=" + theData.get(attribute.name));
                    if(attribute.getBoolean("propertyReadOnly")){
                        continue;
                    }
                    Ognl.setValue(attribute.getString("propertyPath"), child, Ognl.getValue(attribute.getString("name"), theData));
                }
        
                for(Thing attribute : self.getChilds("attribute")){
                    theData.put(attribute.getString("name"), Ognl.getValue(attribute.getString("propertyPath"), child));
                }
        
                updated = true;
                break;
            }
        }
        
        return updated;
    }
#$@text#$@
        sNO_BACKGROUND=false
        sNO_FOCUS=false
        sNO_MERGE_PAINTS=false
        sNO_REDRAW_RESIZE=false
        sNO_RADIO_GROUP=false
        sEMBEDDED=false
        sDOUBLE_BUFFERED=false
        scapture=false
        senabled=true
        sredraw=true
        svisible=true
        sdescriptors=xworker.swt.Widgets/@StyledText
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=codeText
          @/@SwtGuide/@BrowserComposite111/@Composite/@codeText/@Colorer
          sname=Colorer
          scodeName=java
          scodeType=java
          sdescriptors=xworker.swt.custom.StyledText/@Colorer
          sinheritDescription=false
          sth_createIndex=false
          sth_registMyChilds=false
          sth_registDisabled=false
          sth_mark=false
          sid=Colorer
      @/@SwtGuide/@BrowserComposite111/@Buttons
      sname=Buttons
      sdescriptors=xworker.swt.guide.Node/@Buttons
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Buttons
        @/@SwtGuide/@BrowserComposite111/@Buttons/@nextButton
        sname=nextButton
        slabel=上一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton1
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton
        @/@SwtGuide/@BrowserComposite111/@Buttons/@nextButton1
        sname=nextButton
        slabel=下一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton1
    @/@SwtGuide/@BrowserComposite1111
    sname=BrowserComposite
    slabel=doDelete
    sbrowserLocation=top
    surlType=thingDoc
    Sdescription=
#$@text#$@
<p>doDelete方法是删除当前数据对象对应的数据，如删除数据库中的一条记录。doDelete成功删除了记录返回true，没有删除记录返回false。</p>

<p>下面是ListDataObject的doDelete方法的实现。</p>

<p>&nbsp;</p>
#$@text#$@
    sdescriptors=xworker.swt.guide.Guide/@BrowserComposite
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=BrowserComposite1111
      @/@SwtGuide/@BrowserComposite1111/@Composite
      sname=Composite
      sBORDER=false
      sH_SCROLL=false
      sV_SCROLL=false
      sNO_BACKGROUND=false
      sNO_FOCUS=false
      sNO_MERGE_PAINTS=false
      sNO_REDRAW_RESIZE=false
      sNO_RADIO_GROUP=false
      sEMBEDDED=false
      sDOUBLE_BUFFERED=false
      scapture=false
      senabled=true
      sredraw=true
      svisible=true
      sdescriptors=xworker.swt.guide.Guide/@BrowserComposite/@Composite
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Composite
        @/@SwtGuide/@BrowserComposite1111/@Composite/@compositeFillLayout
        sname=compositeFillLayout
        stype=SWT.HORIZONTAL
        sdescriptors=xworker.swt.Layouts/@FillLayout
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=compositeFillLayout
        @/@SwtGuide/@BrowserComposite1111/@Composite/@codeText
        sname=codeText
        sstyle=MULTI
        sFULL_SELECTION=false
        sREAD_ONLY=true
        sWRAP=false
        sH_SCROLL=true
        sV_SCROLL=true
        sBORDER=false
        salign=LEFT
        slineNumber=false
        Stext=
#$@text#$@
@SuppressWarnings("unchecked")
	public static Object doDelete(ActionContext actionContext) throws OgnlException{
    	//数据对象定义
        Thing self = actionContext.getObject("self");
        //数据对象
        DataObject theData = actionContext.getObject("theData");
        
        //根据主键查找对象
        List<Object> datas = (List<Object>) self.doAction("getListData", actionContext);        
        Object[][] keyDatas = theData.getKeyAndDatas();
        boolean deleted = false;
        for(Object child : datas){
            boolean ok = true;
            for(Object[] keyData : keyDatas){
                if(keyData[1] != null && keyData[1] != Ognl.getValue(((Thing) keyData[0]).getString("propertyPath"), child)){
                    ok = false;
                    break;
                }
            }
            
            if(ok){
            	//存在则删除该对象
                datas.remove(child);
                deleted = true;
                break;
            }
        }
        
        return deleted;
    }
#$@text#$@
        sNO_BACKGROUND=false
        sNO_FOCUS=false
        sNO_MERGE_PAINTS=false
        sNO_REDRAW_RESIZE=false
        sNO_RADIO_GROUP=false
        sEMBEDDED=false
        sDOUBLE_BUFFERED=false
        scapture=false
        senabled=true
        sredraw=true
        svisible=true
        sdescriptors=xworker.swt.Widgets/@StyledText
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=codeText
          @/@SwtGuide/@BrowserComposite1111/@Composite/@codeText/@Colorer
          sname=Colorer
          scodeName=java
          scodeType=java
          sdescriptors=xworker.swt.custom.StyledText/@Colorer
          sinheritDescription=false
          sth_createIndex=false
          sth_registMyChilds=false
          sth_registDisabled=false
          sth_mark=false
          sid=Colorer
      @/@SwtGuide/@BrowserComposite1111/@Buttons
      sname=Buttons
      sdescriptors=xworker.swt.guide.Node/@Buttons
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Buttons
        @/@SwtGuide/@BrowserComposite1111/@Buttons/@nextButton
        sname=nextButton
        slabel=上一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton1
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton
        @/@SwtGuide/@BrowserComposite1111/@Buttons/@nextButton1
        sname=nextButton
        slabel=下一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton1
    @/@SwtGuide/@BrowserComposite11111
    sname=BrowserComposite
    slabel=doQuery
    sbrowserLocation=top
    surlType=thingDoc
    Sdescription=
#$@text#$@
<p>doQuery方法用于查询数据，返回值是List&lt;DataObject&gt;。</p>

<p><strong>doQuery方法的主要参数如下：</strong></p>

<ul>
	<li><strong>conditionConfig：Thing</strong><br />
	查询条件定义。用于生产查询条件的表达式，如生成数据库的查询条件SQL等。<br />
	&nbsp;</li>
	<li><strong>conditionData: Object</strong><br />
	查询条件数据。和conditionConfig一起工作，如果一个表达式没有值那么会忽略。如user = ?，如果conditionData没有对应?的数据，则该条件表达式被忽略。<br />
	&nbsp;</li>
	<li><strong>pageInfo：Object</strong><br />
	分页和排序信息。</li>
</ul>

<p>下面是ListDataObject的doQuery方法的实现。</p>

<p>&nbsp;</p>
#$@text#$@
    sdescriptors=xworker.swt.guide.Guide/@BrowserComposite
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=BrowserComposite11111
      @/@SwtGuide/@BrowserComposite11111/@Composite
      sname=Composite
      sBORDER=false
      sH_SCROLL=false
      sV_SCROLL=false
      sNO_BACKGROUND=false
      sNO_FOCUS=false
      sNO_MERGE_PAINTS=false
      sNO_REDRAW_RESIZE=false
      sNO_RADIO_GROUP=false
      sEMBEDDED=false
      sDOUBLE_BUFFERED=false
      scapture=false
      senabled=true
      sredraw=true
      svisible=true
      sdescriptors=xworker.swt.guide.Guide/@BrowserComposite/@Composite
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Composite
        @/@SwtGuide/@BrowserComposite11111/@Composite/@compositeFillLayout
        sname=compositeFillLayout
        stype=SWT.HORIZONTAL
        sdescriptors=xworker.swt.Layouts/@FillLayout
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=compositeFillLayout
        @/@SwtGuide/@BrowserComposite11111/@Composite/@codeText
        sname=codeText
        sstyle=MULTI
        sFULL_SELECTION=false
        sREAD_ONLY=true
        sWRAP=false
        sH_SCROLL=true
        sV_SCROLL=true
        sBORDER=false
        salign=LEFT
        slineNumber=false
        Stext=
#$@text#$@
@SuppressWarnings("unchecked")
	public static Object doQuery(ActionContext actionContext){
    	//数据对象定义
        Thing self = actionContext.getObject("self");
        
        //获取数据实例
        List<Object> instance = (List<Object>) self.doAction("getListData", actionContext);
        List<DataObject> matchedDatas = new ArrayList<DataObject>();
        //log.info("listDataName=" + self.listData + ",instance=" + instance);
        //从实例中查询匹配的数据
        if(actionContext.get("conditionConfig") == null && instance != null){
            //没有条件，返回全部
            for(Object child : instance){        
                Object dobj = child;
                if(self.getString("extends") == null || "".equals(self.getString("extends"))){
                    dobj = self.doAction("createDataObjectFromObject", actionContext, "data", child, "descriptor", self);
                }
                //log.info("dobj=" + dobj);
                if(dobj != null){
                    matchedDatas.add((DataObject) dobj);
                }
            }
        }else{
        	if(instance != null){
	            for(Object child : instance){
	                Object dobj = child;
	                if(self.getString("extends") == null || "".equals(self.getString("extends"))){
	                    dobj = self.doAction("createDataObjectFromObject", actionContext, "data", child, "descriptor", self);
	                }
	                if(dobj != null){
	                	Thing conditionConfig = actionContext.getObject("conditionConfig");
	                    Boolean matched = (Boolean) conditionConfig.doAction("isMatch", actionContext, "condition", actionContext.get("conditionData"), "data", dobj );        
	                    //log.info("matched=" + matched);
	                    if(matched){
	                        matchedDatas.add((DataObject) dobj);
	                    }        
	                }
	            }
        	}
        }
        
        //分页，如果pageInfo存在则分页，否则是返回符合条件的全部记录
        if(actionContext.get("pageInfo") != null){
        	final PageInfo pageInfo = PageInfo.getPageInfo(actionContext);
            //是否排序
            if(pageInfo.getSort() != null &&  !"".equals(pageInfo.getSort())){
            	Collections.sort(matchedDatas, new Comparator<Object>(){
					@Override
					public int compare(Object o1, Object o2) {
						DataObject a = (DataObject) o1;
						DataObject b = (DataObject) o2;
						
						String av = (a == null ? null : a.getString((String) pageInfo.getSort()));
	                    String bv = (b == null ? null : b.getString((String) pageInfo.getSort()));
	                    if(av == null && bv == null){
	                        return 0;
	                    }else if(av == null && bv != null){
	                        return  "DESC".equals(pageInfo.getDir()) ? 1 : -1;
	                    }else if(av != null && bv == null){
	                        return "DESC".equals(pageInfo.getDir()) ? -1 : 1;
	                    }else{
	                        return "DESC".equals(pageInfo.getDir()) ? -av.compareTo(bv) : av.compareTo(bv);
	                    }            
					}
            	});
            
            }
            pageInfo.setTotalCount( matchedDatas.size());
            if(pageInfo.getLimit() > 0){
                if(pageInfo.getStart() > matchedDatas.size()){
                    pageInfo.setStart(matchedDatas.size());
                }
                int toIndex = pageInfo.getStart() + pageInfo.getLimit();
                if(toIndex > matchedDatas.size()){ 
                    toIndex = matchedDatas.size();
                }
                int startIndex = pageInfo.getStart();
                if(startIndex < 0){
                    startIndex = 0;
                }    
                pageInfo.setDatas(matchedDatas.subList(pageInfo.getStart(), toIndex));
            }else{
                pageInfo.setDatas(matchedDatas);
            }
            return pageInfo.getDatas();
        }else{
            if(actionContext.get("pageInfo") != null){
            	PageInfo pageInfo = PageInfo.getPageInfo(actionContext);
                pageInfo.setTotalCount(matchedDatas.size());
                pageInfo.setDatas(matchedDatas);
            }
            return matchedDatas;
        }
    }
#$@text#$@
        sNO_BACKGROUND=false
        sNO_FOCUS=false
        sNO_MERGE_PAINTS=false
        sNO_REDRAW_RESIZE=false
        sNO_RADIO_GROUP=false
        sEMBEDDED=false
        sDOUBLE_BUFFERED=false
        scapture=false
        senabled=true
        sredraw=true
        svisible=true
        sdescriptors=xworker.swt.Widgets/@StyledText
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=codeText
          @/@SwtGuide/@BrowserComposite11111/@Composite/@codeText/@Colorer
          sname=Colorer
          scodeName=java
          scodeType=java
          sdescriptors=xworker.swt.custom.StyledText/@Colorer
          sinheritDescription=false
          sth_createIndex=false
          sth_registMyChilds=false
          sth_registDisabled=false
          sth_mark=false
          sid=Colorer
      @/@SwtGuide/@BrowserComposite11111/@Buttons
      sname=Buttons
      sdescriptors=xworker.swt.guide.Node/@Buttons
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Buttons
        @/@SwtGuide/@BrowserComposite11111/@Buttons/@nextButton
        sname=nextButton
        slabel=上一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton1
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton
        @/@SwtGuide/@BrowserComposite11111/@Buttons/@nextButton1
        sname=nextButton
        slabel=下一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton1
    @/@SwtGuide/@BrowserComposite111111
    sname=BrowserComposite
    slabel=iterator
    sbrowserLocation=top
    surlType=thingDoc
    Sdescription=
#$@text#$@
<p>iterator是doQuery方法的变种。doQuery方法一次性返回查询结果，如果数据量很大那么内存会溢出等。iterator方法是查询后遍历结果，读出一条数据就调用传入的动作处理。iterator一般用于数据导出等场合。</p>

<p>下面是ListDataObject的iterator方法的实现。</p>

<p>&nbsp;</p>
#$@text#$@
    sdescriptors=xworker.swt.guide.Guide/@BrowserComposite
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=BrowserComposite111111
      @/@SwtGuide/@BrowserComposite111111/@Composite
      sname=Composite
      sBORDER=false
      sH_SCROLL=false
      sV_SCROLL=false
      sNO_BACKGROUND=false
      sNO_FOCUS=false
      sNO_MERGE_PAINTS=false
      sNO_REDRAW_RESIZE=false
      sNO_RADIO_GROUP=false
      sEMBEDDED=false
      sDOUBLE_BUFFERED=false
      scapture=false
      senabled=true
      sredraw=true
      svisible=true
      sdescriptors=xworker.swt.guide.Guide/@BrowserComposite/@Composite
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Composite
        @/@SwtGuide/@BrowserComposite111111/@Composite/@compositeFillLayout
        sname=compositeFillLayout
        stype=SWT.HORIZONTAL
        sdescriptors=xworker.swt.Layouts/@FillLayout
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=compositeFillLayout
        @/@SwtGuide/@BrowserComposite111111/@Composite/@codeText
        sname=codeText
        sstyle=MULTI
        sFULL_SELECTION=false
        sREAD_ONLY=true
        sWRAP=false
        sH_SCROLL=true
        sV_SCROLL=true
        sBORDER=false
        salign=LEFT
        slineNumber=false
        Stext=
#$@text#$@
@SuppressWarnings("unchecked")
	public static void iterator(ActionContext actionContext) throws Exception{
		Thing self = (Thing) actionContext.get("self");
		Object ac = actionContext.get("action");
		Action action = null;
		if(ac instanceof Action){
			action = (Action) ac;
		}else if(ac instanceof Thing){
			action = ((Thing) ac).getAction();
		}else if(ac instanceof String){
			action = World.getInstance().getAction((String) ac);
		}else{
			throw new ActionException("Iterator: action is null or not a (Action、Thing or String), path=" + self.getMetadata().getPath());
		}
		
		List<DataObject> datas = (List<DataObject>) ListDataObjectActions.doQuery(actionContext);
		if(datas != null){
			for(int i=0; i < datas.size(); i++){
				action.run(actionContext, UtilMap.toMap("index", (i + 1), "data", datas.get(i)));
			}
		}
	}
#$@text#$@
        sNO_BACKGROUND=false
        sNO_FOCUS=false
        sNO_MERGE_PAINTS=false
        sNO_REDRAW_RESIZE=false
        sNO_RADIO_GROUP=false
        sEMBEDDED=false
        sDOUBLE_BUFFERED=false
        scapture=false
        senabled=true
        sredraw=true
        svisible=true
        sdescriptors=xworker.swt.Widgets/@StyledText
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=codeText
          @/@SwtGuide/@BrowserComposite111111/@Composite/@codeText/@Colorer
          sname=Colorer
          scodeName=java
          scodeType=java
          sdescriptors=xworker.swt.custom.StyledText/@Colorer
          sinheritDescription=false
          sth_createIndex=false
          sth_registMyChilds=false
          sth_registDisabled=false
          sth_mark=false
          sid=Colorer
      @/@SwtGuide/@BrowserComposite111111/@Buttons
      sname=Buttons
      sdescriptors=xworker.swt.guide.Node/@Buttons
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Buttons
        @/@SwtGuide/@BrowserComposite111111/@Buttons/@nextButton
        sname=nextButton
        slabel=上一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton1
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton
        @/@SwtGuide/@BrowserComposite111111/@Buttons/@nextButton1
        sname=nextButton
        slabel=下一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton1
    @/@SwtGuide/@SimpleBrowser1
    sname=SimpleBrowser
    slabel=总结
    stype=thingDoc
    Sdescription=
#$@text#$@
<p>以上介绍了定义数据对象的基本方法，更多数据对象的接口定义可以参看<a href="do?sc=xworker.ide.worldexplorer.swt.http.ThingDoc/@desc&amp;thing=xworker.dataObject.DataObject">DataObject</a>。</p>
#$@text#$@
    sdescriptors=xworker.swt.guide.Guide/@SimpleBrowser
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=SimpleBrowser1
      @/@SwtGuide/@SimpleBrowser1/@Buttons
      sname=Buttons
      sdescriptors=xworker.swt.guide.Node/@Buttons
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=Buttons
        @/@SwtGuide/@SimpleBrowser1/@Buttons/@nextButton
        sname=nextButton
        slabel=上一步
        sdescriptors=xworker.swt.guide.Buttons/@NextButton1
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=nextButton
        @/@SwtGuide/@SimpleBrowser1/@Buttons/@GoButton
        sname=GoButton
        slabel=重新开始教程
        sthingPath=xworker.things.p2018.p11.p07.DefineDataObjectTutorials/@SwtGuide/@SimpleBrowser
        sdescriptors=xworker.swt.guide.Buttons/@GoButton
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=GoButton
