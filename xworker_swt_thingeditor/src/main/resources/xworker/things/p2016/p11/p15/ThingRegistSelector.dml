%1575613035973
@
sname=shell
stext=注册事物选择器
sNO_TRIM=false
sCLOSE=true
sTITLE=true
sMIN=true
sMAX=true
sBORDER=false
sRESIZE=true
sON_TOP=false
sTOOL=false
sNO_FOCUS=false
swidth=800
sheight=600
scenterScreen=true
spack=false
smaximized=false
sfullScreen=false
sdesign=true
sisIde=false
sdesignDefaultOpen=false
sH_SCROLL=false
sV_SCROLL=false
sNO_BACKGROUND=false
sNO_MERGE_PAINTS=false
sNO_REDRAW_RESIZE=false
sNO_RADIO_GROUP=false
sEMBEDDED=false
sDOUBLE_BUFFERED=false
slabel=ThingRegistSelector
scapture=false
senabled=true
sredraw=true
svisible=true
sdescriptors=xworker.swt.widgets.Shell
sinheritDescription=false
sth_createIndex=false
sth_registMyChilds=false
sth_registDisabled=false
sth_mark=false
  @/@shellGridLayout
  sname=shellGridLayout
  smakeColumnsEqualWidth=false
  smarginWidth=5
  smarginHeight=5
  smarginLeft=0
  smarginTop=0
  smarginRight=0
  smarginBottom=0
  shorizontalSpacing=5
  sverticalSpacing=5
  sdescriptors=xworker.swt.Layouts/@GridLayout
  sinheritDescription=false
  sth_createIndex=false
  sth_registMyChilds=false
  sth_registDisabled=false
  sth_mark=false
  sid=shellGridLayout
  @/@registComposite
  sname=registComposite
  sBORDER=false
  sH_SCROLL=false
  sV_SCROLL=false
  sNO_BACKGROUND=false
  sNO_FOCUS=false
  sNO_MERGE_PAINTS=false
  sNO_REDRAW_RESIZE=false
  sNO_RADIO_GROUP=false
  sEMBEDDED=false
  sDOUBLE_BUFFERED=false
  scapture=false
  senabled=true
  sredraw=true
  svisible=true
  sdescriptors=xworker.swt.Widgets/@Composite
  sinheritDescription=false
  sth_createIndex=false
  sth_registMyChilds=false
  sth_registDisabled=false
  sth_mark=false
  sid=registComposite
    @/@registComposite/@thingRegistGridData
    sname=thingRegistGridData
    sstyle=FILL_BOTH
    shorizontalIndent=0
    swidth=-1
    sheight=-1
    shorizontalAlignment=BEGINNING
    sverticalAlignment=CENTER
    shorizontalSpan=1
    sverticalSpan=1
    sgrabExcessHorizontalSpace=false
    sgrabExcessVerticalSpace=false
    sdescriptors=xworker.swt.layout.LayoutDatas/@GridData
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=thingRegistGridData
    @/@registComposite/@thingRegist
    sname=thingRegist1
    sparent=false
    ssearchByKeywords=true
    sshowContent=true
    scontentDisplayType=Composite
    scontentDefaultOpenMethod=thingDescBrowser
    sforceUseDefaultOpenMethod=false
    sshowDescBrowser=true
    sdescBrowserRight=true
    sautoLoad=false
    scache=true
    scheck=false
    sdescritporForNewThing=xworker.lang.MetaDescriptor3
    sdescritporChilds=false
    sdescriptors=xworker.swt.Widgets/@ThingRegistSelector
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=thingRegist
      @/@registComposite/@thingRegist/@actions
      sname=actions
      sdescriptors=xworker.swt.xworker.ThingRegistSelector/@actions1
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=actions
        @/@registComposite/@thingRegist/@actions/@selected
        sname=selected
        sisSynchronized=false
        sthrowException=true
        suseOtherAction=false
        svarScope=Local
        sdisableGlobalContext=false
        Scode=
#$@text#$@
if(thing != null){
    _g.put("resultThing", thing.getMetadata().getPath());
    okButton.setEnabled(true);
}else{
    _g.put("resultThing", null);
    okButton.setEnabled(false);
}
#$@text#$@
        sinterpretationType=Action
        screateLocalVarScope=false
        ssaveReturn=false
        sdebugLog=false
        sdescriptors=xworker.lang.actions.Actions/@GroovyAction
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=selected
    @/@registComposite/@registThingEditor
    sname=registThingEditor
    sstyle=HORIZONTAL
    sSMOOTH=false
    sweights=30,70
    sBORDER=false
    sH_SCROLL=false
    sV_SCROLL=false
    sNO_BACKGROUND=false
    sNO_FOCUS=false
    sNO_MERGE_PAINTS=false
    sNO_REDRAW_RESIZE=false
    sNO_RADIO_GROUP=false
    sEMBEDDED=false
    sDOUBLE_BUFFERED=false
    scapture=false
    senabled=true
    sredraw=true
    svisible=true
    sdescriptors=xworker.swt.Widgets/@SashForm
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=registThingEditor
      @/@registComposite/@registThingEditor/@thingRegist2
      sname=thingRegist2
      ssearchByKeywords=true
      sshowDescBrowser=false
      sdescBrowserRight=false
      sautoLoad=false
      scache=true
      sdescritporForNewThing=xworker.lang.MetaDescriptor3
      sdescriptors=xworker.swt.Widgets/@ThingRegistSelector
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=thingRegist2
        @/@registComposite/@registThingEditor/@thingRegist2/@actions
        sname=actions
        sdescriptors=xworker.swt.xworker.ThingRegistSelector/@actions1
        sinheritDescription=false
        sth_createIndex=false
        sth_registMyChilds=false
        sth_registDisabled=false
        sth_mark=false
        sid=actions
          @/@registComposite/@registThingEditor/@thingRegist2/@actions/@selected
          sname=selected
          sisSynchronized=false
          sthrowException=true
          suseOtherAction=false
          svarScope=Local
          sdisableGlobalContext=false
          Scode=
#$@text#$@
if(thing != null){
    _g.put("result", thing.getMetadata().getPath());
    okButton.setEnabled(true);

    thingEditor.editorActions.doAction("setThing", ["thing":thing]);
}else{
    _g.put("result", null);
    okButton.setEnabled(false);
}
#$@text#$@
          sinterpretationType=Action
          screateLocalVarScope=false
          ssaveReturn=false
          sdebugLog=false
          sdescriptors=xworker.lang.actions.Actions/@GroovyAction
          sinheritDescription=false
          sth_createIndex=false
          sth_registMyChilds=false
          sth_registDisabled=false
          sth_mark=false
          sid=selected
      @/@registComposite/@registThingEditor/@thingEditor
      sname=thingEditor
      stitle=true
      suseRootThing=false
      sdescriptors=xworker.swt.Widgets/@ThingEditor
      sinheritDescription=false
      sth_createIndex=false
      sth_registMyChilds=false
      sth_registDisabled=false
      sth_mark=false
      sid=thingEditor
    @/@registComposite/@stackLayout
    sname=stackLayout
    stopControl=registThingEditor
    sdescriptors=xworker.swt.Layouts/@StackLayout
    sinheritDescription=false
    sth_createIndex=false
    sth_registMyChilds=false
    sth_registDisabled=false
    sth_mark=false
    sid=stackLayout
  @/@2610
  sname=buttonComposite
  sBORDER=false
  sH_SCROLL=false
  sV_SCROLL=false
  sNO_BACKGROUND=false
  sNO_FOCUS=false
  sNO_MERGE_PAINTS=false
  sNO_REDRAW_RESIZE=false
  sNO_RADIO_GROUP=false
  sEMBEDDED=false
  sDOUBLE_BUFFERED=false
  scapture=false
  senabled=true
  sredraw=true
  svisible=true
  sdescriptors=xworker.swt.Widgets/@Composite
  sid=2610
    @/@2610/@2611
    sname=buttonCompositeGridData
    sstyle=FILL_HORIZONTAL
    shorizontalIndent=0
    swidth=-1
    sheight=-1
    shorizontalAlignment=END
    sverticalAlignment=CENTER
    shorizontalSpan=1
    sverticalSpan=1
    sgrabExcessHorizontalSpace=false
    sgrabExcessVerticalSpace=false
    sdescriptors=xworker.swt.layout.LayoutDatas/@GridData
    sid=2611
    @/@2610/@2612
    sname=buttonCompositeRowLayout
    sfill=false
    sjustify=false
    smarginWidth=0
    smarginHeight=0
    smarginLeft=3
    smarginTop=3
    smarginRight=3
    smarginBottom=3
    spack=true
    sspacing=3
    stype=SWT.HORIZONTAL
    swrap=true
    sdescriptors=xworker.swt.Layouts/@RowLayout
    sid=2612
    @/@2610/@2613
    sname=okButton
    stext=确定
    stype=SWT.PUSH
    sflat=false
    sborder=false
    sselected=false
    scapture=false
    senabled=false
    sredraw=true
    svisible=true
    sdescriptors=xworker.swt.Widgets/@Button
    sth_createIndex=false
    sid=2613
      @/@2610/@2613/@2614
      sname=RowData
      sexclude=false
      swidth=80
      sheight=-1
      sdescriptors=xworker.swt.layout.LayoutDatas/@RowData
      sth_createIndex=false
      sid=2614
      @/@2610/@2613/@2615
      sname=Listeners
      sdescriptors=xworker.swt.widgets.Widget/@Listeners
      sth_createIndex=false
      sid=2615
        @/@2610/@2613/@2615/@2616
        sname=okButtonSelection
        stype=Selection
        sdescriptors=xworker.swt.events.Listeners/@listeners/@Listener
        sth_createIndex=false
        sid=2616
          @/@2610/@2613/@2615/@2616/@SetThing
          sname=SetThing
          sthing=var:resultThing
          sinterpretationType=Self
          sattributeTemplate=false
          schildsAttributeTemplate=false
          svarScope=Local
          sisSynchronized=false
          sthrowException=true
          screateLocalVarScope=false
          ssaveReturn=false
          sdisableGlobalContext=false
          sdebugLog=false
          sdescriptors=xworker.swt.xworker.attributeEditor.AttributeActions/@SetThing
          sinheritDescription=false
          sth_createIndex=false
          sth_registMyChilds=false
          sth_registDisabled=false
          sth_mark=false
          sid=SetThing
          @/@2610/@2613/@2615/@2616/@Dispose
          sname=Dispose
          scontrolList=shell
          sinterpretationType=Self
          sattributeTemplate=false
          schildsAttributeTemplate=false
          svarScope=Local
          sisSynchronized=false
          sthrowException=true
          screateLocalVarScope=false
          ssaveReturn=false
          sdisableGlobalContext=false
          sdebugLog=false
          sdescriptors=xworker.swt.actions.ControlActions/@Dispose
          sinheritDescription=false
          sth_createIndex=false
          sth_registMyChilds=false
          sth_registDisabled=false
          sth_mark=false
          sid=Dispose
    @/@2610/@2617
    sname=cancelButton
    stext=取消
    stype=SWT.PUSH
    sflat=false
    sborder=false
    sselected=false
    scapture=false
    senabled=true
    sredraw=true
    svisible=true
    sdescriptors=xworker.swt.Widgets/@Button
    sth_createIndex=false
    sid=2617
      @/@2610/@2617/@2618
      sname=RowData
      sexclude=false
      swidth=80
      sheight=-1
      sdescriptors=xworker.swt.layout.LayoutDatas/@RowData
      sth_createIndex=false
      sid=2618
      @/@2610/@2617/@2619
      sname=Listeners
      sdescriptors=xworker.swt.widgets.Widget/@Listeners
      sth_createIndex=false
      sid=2619
        @/@2610/@2617/@2619/@2620
        sname=cancelButtonSelection
        stype=Selection
        sdescriptors=xworker.swt.events.Listeners/@listeners/@Listener
        sth_createIndex=false
        sid=2620
          @/@2610/@2617/@2619/@2620/@Dispose
          sname=Dispose
          scontrolList=shell
          sinterpretationType=Self
          sattributeTemplate=false
          schildsAttributeTemplate=false
          svarScope=Local
          sisSynchronized=false
          sthrowException=true
          screateLocalVarScope=false
          ssaveReturn=false
          sdisableGlobalContext=false
          sdebugLog=false
          sdescriptors=xworker.swt.actions.ControlActions/@Dispose
          sinheritDescription=false
          sth_createIndex=false
          sth_registMyChilds=false
          sth_registDisabled=false
          sth_mark=false
          sid=Dispose
  @/@init
  sname=init
  sisSynchronized=false
  sthrowException=true
  suseOtherAction=false
  svarScope=Local
  sdisableGlobalContext=false
  Scode=
#$@text#$@
import org.xmeta.util.UtilString;
import org.eclipse.swt.SWT;
import org.eclipse.swt.widgets.MessageBox;

def param = actionContext.get("param");
//println param;

Map<String, String> params = UtilString.getParams(param, ",");
for(key in params.keySet()){
    actionContext.g().put(key, params.get(key));
}
//println params;

def thing = world.getThing(params.thing);
if(thing == null){
    def box = new MessageBox(shell, SWT.ICON_WARNING | SWT.OK);
    box.setText("选择注册事物");
    box.setMessage("没有设置注册事物，不能选择！");
    box.open();
    shell.dispose();
    return;
}

def thingRegist = null;
def defaultViewer = null;
// println "viewType=" + params.viewType;
// println "thing=" + thing;
if(params.viewType == "thingEditor"){
    thingRegist = thingRegist2;    
}else if(params.viewType == "default" || params.viewType == null){
    defaultViewer = getViewer(thing);
    //println "defaultViewer=" + defaultViewer;
    thingRegist = thingRegist1;
    stackLayout.topControl = thingRegist1.doAction("getRootControl");
    registComposite.layout();
}else{
    thingRegist = thingRegist1;
    stackLayout.topControl = thingRegist1.doAction("getRootControl");
    registComposite.layout();
}

thingRegist.doAction("init", actionContext, "thing", thing, 
    "type", params.registType,
    "descritporForNewThing", params.descritporForNewThing);
if(params.viewType != null && params.viewType != "" &&  params.viewType != "default"){   
    thingRegist.getActionContext().put("contentDefaultOpenMethod", params.viewType);
    thingRegist.getActionContext().put("forceUseDefaultOpenMethod", true);
}  
thingRegist.getActionContext().put("defaultViewer", defaultViewer);  
thingRegist.doAction("refresh");

def getViewer(thing){
    //首先取自己的
    if(thing.getThingName() == "ThingIndex"){
        def path = thing.getStringBlankAsNull("defaultViewer");
        viewer = getViewer_(thing, path);
        if(viewer != null){
            return viewer;
        }
    }
    //println thing;
    def viewer = getViewer_(thing, thing.getStringBlankAsNull("th_thingRegistViewer"));
    
    if(viewer == null){
        for(desc in thing.getAllDescriptors()){
            //println desc;
            viewer = getViewer_(thing, desc.getStringBlankAsNull("th_thingRegistViewer"));
            if(viewer != null){
                return viewer;
            }
        }
    }

    if(viewer == null){
        for(extd in thing.getAllExtends()){
            // println "exted:" extd;
            viewer = getViewer_(thing, extd.getStringBlankAsNull("th_thingRegistViewer"));
            if(viewer != null){
                return viewer;
            }
        }
    }
    
    return viewer;
}

def getViewer_(thing, path){
    if(path == null){
        return null;
    }else if(path == "self"){
        return thing;
    }else{
        return world.getThing(path);
    }
}
#$@text#$@
  sinterpretationType=Action
  screateLocalVarScope=false
  ssaveReturn=false
  sswitchResult=false
  sdebugLog=false
  sdescriptors=xworker.swt.widgets.Widget/@Code
  sinheritDescription=false
  sth_createIndex=false
  sth_registMyChilds=false
  sth_registDisabled=false
  sth_mark=false
  sid=init
